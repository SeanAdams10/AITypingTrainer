# PracticeSession Object Specification

> **NOTE:** `session_id` is always an **integer** throughout the application and database. All APIs, models, and DB tables use integer session IDs. Any previous references to string/UUID session IDs are obsolete.

## 1. Overview
A PracticeSession tracks a user's typing drill, including timing, indices, stats, and results. Sessions are the core entity for analytics and progress tracking.

## 2. Data Model
- **session_id**: Integer (Primary Key)
- **snippet_id**: Integer (Foreign Key to Snippet)
- **snippet_index_start**: Integer
- **snippet_index_end**: Integer
- **start_time**: DateTime
- **end_time**: DateTime
- **total_time**: Float (seconds)
- **session_wpm**: Float
- **session_cpm**: Float
- **expected_chars**: Integer
- **actual_chars**: Integer
- **errors**: Integer
- **accuracy**: Float

## 3. Functional Requirements
- Sessions are created at drill start and updated on completion
- All relevant stats and indices are recorded
- Linked to keystrokes, errors, and ngram results

### 3.1 Session Creation

- **session_id**: Unique integer ID generated by the application
- **snippet_id**: Foreign key to Snippet
- **snippet_index_start**: Start index of snippet
- **snippet_index_end**: End index of snippet
- **start_time**: Time when session starts
- **end_time**: Time when session ends
- **total_time**: Total time taken for session
- **session_wpm**: Words per minute
- **session_cpm**: Characters per minute
- **expected_chars**: Expected characters
- **actual_chars**: Actual characters
- **errors**: Number of errors
- **accuracy**: Accuracy percentage

### 3.2 Session Update

- **end_time**: Time when session ends
- **total_time**: Total time taken for session
- **session_wpm**: Words per minute
- **session_cpm**: Characters per minute
- **expected_chars**: Expected characters
- **actual_chars**: Actual characters
- **errors**: Number of errors
- **accuracy**: Accuracy percentage

## 4. API Endpoints
- `POST /api/sessions`: Start a new session
- `PUT /api/sessions/<id>`: Update session with results
- `GET /api/sessions/<id>`: Fetch session details

## 5. UI Requirements
- Sessions are created/managed automatically by the DrillConfig and TypingDrill UIs
- Session summaries shown at drill completion

## 6. Testing
- Backend, API, and UI tests must cover all session creation, update, and retrieval
- All tests must run on a clean DB and be independent

## 7. Security/Validation
- No SQL injection (parameterized queries)
- No sensitive data hardcoded
- All user input is validated and sanitized

---

## 8. API Implementation and Structure
- All PracticeSession API endpoints are implemented in `session_api.py` using a Flask Blueprint (`session_api`).
- Endpoints only handle request/response, validation, and error handling.
- All business logic (creation, update, retrieval, DB access) is handled in `db/models/practice_session.py`.
- Endpoints:
  - `POST /api/sessions`: Start a new session
  - `GET /api/sessions/<id>`: Fetch session details
  - `GET /api/session/info?snippet_id=<id>`: Get the most recent session indices for a snippet_id, based on session end_time
  if no practice sessions exist for the given snippet id, return 0 for both snippet_index_start and snippet_index_end
  Returns: {snippet_id, snippet_index_start, snippet_index_end}

## 9. Testing
- Unit tests for session model logic
- API tests for all endpoints in `tests/test_session_api.py`
- UI tests for session creation and summary in both web and desktop UIs
- All tests use pytest, pytest-mock, and proper fixtures for DB isolation
- No test uses the production DB; all tests are independent and parameterized

## 10. Database Structure

### 10.1 practice_sessions Table

- **session_id**: Integer (Primary Key)
- **snippet_id**: Integer (Foreign Key to Snippet)
- **snippet_index_start**: Integer
- **snippet_index_end**: Integer
- **start_time**: DateTime
- **end_time**: DateTime
- **total_time**: Float (seconds)
- **session_wpm**: Float
- **session_cpm**: Float
- **expected_chars**: Integer
- **actual_chars**: Integer
- **errors**: Integer
- **accuracy**: Float

### 10.2 session_keystrokes Table

- **keystroke_id**: Integer (Primary Key)
- **session_id**: Integer (Foreign Key to practice_sessions)
- **keystroke_time**: DateTime
- **keystroke_char**: String
- **is_correct**: Boolean

### 10.3 Error Tracking in Keystrokes Table

Errors are now tracked directly in the session_keystrokes table using the is_correct field:

- When is_correct = 1: The keystroke was typed correctly
- When is_correct = 0: The keystroke represents an error

This approach simplifies the schema and provides all error information directly in the keystroke records.
